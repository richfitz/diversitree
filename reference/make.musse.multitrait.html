<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>MuSSE: Multi-State Speciation and Extinction (Multiple Binary Traits Version) — make.musse.multitrait • diversitree</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="MuSSE: Multi-State Speciation and Extinction (Multiple Binary Traits Version) — make.musse.multitrait"><meta property="og:description" content="Prepare to run MuSSE or Mkn (Multi-State Speciation and
  Extinction) on a phylogenetic tree and character distribution.  This
  function creates a likelihood function that can be used in
  maximum likelihood or Bayesian
  inference.
This is a helper function that wraps the basic MuSSE/Mkn models for
  the case of a combination of several binary traits; its
  parametrisation and argument handling are a little different to the
  other models in diversitree."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">diversitree</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.10-0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>MuSSE: Multi-State Speciation and Extinction (Multiple Binary Traits Version)</h1>

    <div class="hidden name"><code>make.musse.multitrait.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Prepare to run MuSSE or Mkn (Multi-State Speciation and
  Extinction) on a phylogenetic tree and character distribution.  This
  function creates a likelihood function that can be used in
  <a href="find.mle.html">maximum likelihood</a> or <a href="mcmc.html">Bayesian</a>
  inference.</p>
<p>This is a helper function that wraps the basic MuSSE/Mkn models for
  the case of a combination of several binary traits; its
  parametrisation and argument handling are a little different to the
  other models in diversitree.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">make.musse.multitrait</span><span class="op">(</span><span class="va">tree</span>, <span class="va">states</span>, sampling.f<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>                      depth<span class="op">=</span><span class="cn">NULL</span>, allow.multistep<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                      strict<span class="op">=</span><span class="cn">TRUE</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">make.mkn.multitrait</span><span class="op">(</span><span class="va">tree</span>, <span class="va">states</span>,</span>
<span>                    depth<span class="op">=</span><span class="cn">NULL</span>, allow.multistep<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                    strict<span class="op">=</span><span class="cn">TRUE</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">musse.multitrait.translate</span><span class="op">(</span><span class="va">n.trait</span>, depth<span class="op">=</span><span class="cn">NULL</span>, names<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>                           allow.multistep<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">mkn.multitrait.translate</span><span class="op">(</span><span class="va">n.trait</span>, depth<span class="op">=</span><span class="cn">NULL</span>, names<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>                         allow.multistep<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">starting.point.musse.multitrait</span><span class="op">(</span><span class="va">tree</span>, <span class="va">lik</span>, q.div<span class="op">=</span><span class="fl">5</span>, yule<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <p></p>
<dl><dt id="arg-tree">tree<a class="anchor" aria-label="anchor" href="#arg-tree"></a></dt>
<dd><p>An ultrametric bifurcating phylogenetic tree, in
    <code>ape</code> “phylo” format.</p></dd>


  <dt id="arg-states">states<a class="anchor" aria-label="anchor" href="#arg-states"></a></dt>
<dd><p>A <code>data.frame</code> of character states, each column of
    which represents a different binary state (with values 0 or 1), and
    each row of which represents a taxon.  The row names of
    <code>states</code> must be the names that correspond to the tip labels in
    the phylogenetic tree (<code>tree$tip.label</code>).  The column names
    must be unique and a single character long.  The character "0"
    (zero) is reserved and may not be used. <code>NA</code> values are allowed
    in one or more columns when one or more traits is unknown for a
    taxon.</p></dd>


  <dt id="arg-depth">depth<a class="anchor" aria-label="anchor" href="#arg-depth"></a></dt>
<dd><p>A scalar or vector of length 3 indicating the depth of
    interactions to include in the model.  See Details.</p></dd>


  <dt id="arg-allow-multistep">allow.multistep<a class="anchor" aria-label="anchor" href="#arg-allow-multistep"></a></dt>
<dd><p>Should transition rates be included that imply
    simultaneous changes in more than one trait?  By default this is not
    allowed, but if set to <code>TRUE</code> these rates are included at the
    end of the parameter vector.  Warning: treatment of these will
    change in future versions!</p></dd>


  <dt id="arg-sampling-f">sampling.f<a class="anchor" aria-label="anchor" href="#arg-sampling-f"></a></dt>
<dd><p>Scalar with the estimated proportion of extant
    species that are included in the phylogeny.  A value of <code>0.75</code>
    means that three quarters of extant species are included in the
    phylogeny.  By default all species are assumed to be known.  In the
    future, this will expand to allow state-specific sampling rates.</p></dd>


  <dt id="arg-strict">strict<a class="anchor" aria-label="anchor" href="#arg-strict"></a></dt>
<dd><p>Each column in <code>states</code> is always checked to make
    sure that the values are 0 or 1.  If <code>strict</code> is <code>TRUE</code>
    (the default), then the additional check is made that <em>every</em>
    state is present.  The likelihood models tend to be poorly behaved
    where states are missing, but there are cases (missing intermediate
    states for meristic characters) where allowing such models may be
    useful.  Note that this model may misbehave even if this check is
    met, due to combinations of traits being absent.</p></dd>


  <dt id="arg-control">control<a class="anchor" aria-label="anchor" href="#arg-control"></a></dt>
<dd><p>List of control parameters for the ODE solver.  See
    details in <code><a href="make.bisse.html">make.bisse</a></code>.</p></dd>


  <dt id="arg-lik">lik<a class="anchor" aria-label="anchor" href="#arg-lik"></a></dt>
<dd><p>A likelihood function created by
    <code>make.musse.multitrait</code>.</p></dd>


  <dt id="arg-q-div">q.div<a class="anchor" aria-label="anchor" href="#arg-q-div"></a></dt>
<dd><p>Ratio of diversification rate to character change rate.
    Eventually this will be changed to allow for Mk2 to be used for
    estimating q parameters.</p></dd>


  <dt id="arg-yule">yule<a class="anchor" aria-label="anchor" href="#arg-yule"></a></dt>
<dd><p>Logical: should starting parameters be Yule estimates
    rather than birth-death estimates?</p></dd>


  <dt id="arg-n-trait">n.trait<a class="anchor" aria-label="anchor" href="#arg-n-trait"></a></dt>
<dd><p>Number of binary traits.</p></dd>


  <dt id="arg-names">names<a class="anchor" aria-label="anchor" href="#arg-names"></a></dt>
<dd><p>Vector of names for the traits when using
    musse.multitrait.translate (optional).</p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>Suppose that you have two binary traits that may affect speciation and
  extinction.  In previous versions of diversitree, you had to code the
  possible combinations as states 1, 2, 3, 4, which makes the
  interpretation of the speciation rates (<code>lambda1</code>,
  <code>lambda2</code>, etc) unintuitive.</p>
<p>Let <code>states</code> is a data.frame with columns "A" and "B",
  representing the two binary traits.  We can write the speciation rate
  as
  <!-- % -->
  $$\lambda_0 + \lambda_A X_A + \lambda_B X_B + \lambda_{AB}X_AX_B$$
  <!-- % -->
  where \(X_A\) and \(X_B\) are indicator variables that take the
  value of trait A and B respectively (with values 0 or 1).  In this
  form, \(\lambda_0\) is the intercept,
  \(\lambda_A\) and \(\lambda_B\) are "main
  effects" of traits A and B, and \(\lambda_{AB}\) is the
  "interaction" between these.  We can do a similar trick for the
  extinction rates.</p>
<p>For character transition rates, we first consider changes only in a
  single trait.  For our two trait case we have four "types" of
  character change allowed (A 0-&gt;1, A 1-&gt;0, B 0-&gt;1, and B 1-&gt;0), but the
  rates of change for trait A might depend on the current state of trait
  B (and vice versa).  So we have, for the A0-&gt;1 trait change
  \(q_{A01,0} + q_{A01,B} \times X_B\).  Note that one fewer levels of
  interaction are possible for these character changes than for the
  speciation/extinction parameters.</p>
<p>It may sometimes be desirable to have the multi-trait changes in the
  model.  At present, if <code>allow.multistep</code> is <code>TRUE</code>, all the
  multiple change transitions are included at the end of the parameter
  vector.  For the two trait case these are labelled <code>q00.11</code>,
  <code>q10.01</code>, <code>q01.10</code>, and <code>q11.00</code>, where <code>qij.kl</code>
  represents a change from (A=i, B=j) to (C=k, D=l).  The argument name,
  and treatment, of these may change in future.</p>
<p>This approach generalises out to more than two traits.  For <code>N</code>
  traits, interactions are possible up to the <code>N</code>th order for
  lambda and mu, and up to the <code>N-1</code>th order for q.  The
  <code>depth</code> argument controls how many of these are returned.  If
  this is a scalar, then the same level is used for <code>lambda</code>,
  <code>mu</code> and <code>q</code>.  If it is a vector of length 3, then different
  depths are used for these three types of parameters.  By default, all
  possible interactions are returned and the model has the same number
  of degrees of freedom as the models returned by <code>make.musse</code>
  (except for a reduction in the possible q parameters when
  <code>allow.multistep</code> is <code>FALSE</code>).  Parameters can then be
  further refined with <code>constrain</code>.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="make.bisse.html">make.bisse</a></code> for the basic binary model, and
  <code><a href="make.musse.html">make.musse</a></code> for the basic multistate model.</p></div>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Richard G. FitzJohn</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## The translation between these two bases is fairly straightforward; if</span></span></span>
<span class="r-in"><span><span class="co">## we have a vector of parameters in our new basis 'p' we can convert it</span></span></span>
<span class="r-in"><span><span class="co">## into the original MuSSE basis ('q') through this matrix:</span></span></span>
<span class="r-in"><span><span class="va">tr</span> <span class="op">&lt;-</span> <span class="fu">musse.multitrait.translate</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">tr</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          lambda0 lambdaA lambdaB lambdaAB mu0 muA muB muAB qA01.0 qA01.B qA10.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda00       1       0       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda10       1       1       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda01       1       0       1        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda11       1       1       1        1   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> mu00           0       0       0        0   1   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> mu10           0       0       0        0   1   1   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> mu01           0       0       0        0   1   0   1    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> mu11           0       0       0        0   1   1   1    1      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q00.10         0       0       0        0   0   0   0    0      1      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q00.01         0       0       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q00.11         0       0       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q10.00         0       0       0        0   0   0   0    0      0      0      1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q10.01         0       0       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q10.11         0       0       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q01.00         0       0       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q01.10         0       0       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q01.11         0       0       0        0   0   0   0    0      1      1      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q11.00         0       0       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q11.10         0       0       0        0   0   0   0    0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q11.01         0       0       0        0   0   0   0    0      0      0      1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          qA10.B qB01.0 qB01.A qB10.0 qB10.A</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda00      0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda10      0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda01      0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda11      0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> mu00          0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> mu10          0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> mu01          0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> mu11          0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q00.10        0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q00.01        0      1      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q00.11        0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q10.00        0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q10.01        0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q10.11        0      1      1      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q01.00        0      0      0      1      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q01.10        0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q01.11        0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q11.00        0      0      0      0      0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q11.10        0      0      0      1      1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> q11.01        1      0      0      0      0</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Notice that the rows that correspond to transitions in multiple</span></span></span>
<span class="r-in"><span><span class="co">## traits are all zero by default; this means that these q values will</span></span></span>
<span class="r-in"><span><span class="co">## be zero regardless of the parameter vector used.</span></span></span>
<span class="r-in"><span><span class="va">tr</span><span class="op">[</span><span class="st">"q00.11"</span>,<span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  lambda0  lambdaA  lambdaB lambdaAB      mu0      muA      muB     muAB </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        0        0        0        0        0        0        0        0 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   qA01.0   qA01.B   qA10.0   qA10.B   qB01.0   qB01.A   qB10.0   qB10.A </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        0        0        0        0        0        0        0        0 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## And here is the section of the transition matrix corresponding to the</span></span></span>
<span class="r-in"><span><span class="co">## lambda values; every rate gets a contribution from the intercept term</span></span></span>
<span class="r-in"><span><span class="co">## (lambda0), lambda10 and lambda11 get a contribution from lambdaA, etc.</span></span></span>
<span class="r-in"><span><span class="va">tr</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>          lambda0 lambdaA lambdaB lambdaAB</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda00       1       0       0        0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda10       1       1       0        0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda01       1       0       1        0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> lambda11       1       1       1        1</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## There is currently no nice simulation support for this, so bear with</span></span></span>
<span class="r-in"><span><span class="co">## an ugly script to generate the tree and traits.</span></span></span>
<span class="r-in"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.10</span>, <span class="fl">.15</span>, <span class="fl">.20</span>, <span class="fl">.25</span>, <span class="co"># lambda 00, 10, 01, 11</span></span></span>
<span class="r-in"><span>          <span class="fl">.03</span>, <span class="fl">.03</span>, <span class="fl">.03</span>, <span class="fl">.03</span>, <span class="co"># mu 00, 10, 01, 11</span></span></span>
<span class="r-in"><span>          <span class="fl">.05</span>, <span class="fl">.05</span>, <span class="fl">.0</span>,       <span class="co"># q00.10, q00.01, q00.11</span></span></span>
<span class="r-in"><span>          <span class="fl">.05</span>, <span class="fl">.0</span>,  <span class="fl">.05</span>,      <span class="co"># q10.00, q10.01, q10.11</span></span></span>
<span class="r-in"><span>          <span class="fl">.05</span>, <span class="fl">.0</span>,  <span class="fl">.05</span>,      <span class="co"># q01.00, q01.10, q01.11</span></span></span>
<span class="r-in"><span>          <span class="fl">.0</span>,  <span class="fl">.05</span>, <span class="fl">.05</span><span class="op">)</span>      <span class="co"># q11.00, q11.10, q11.01</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu"><a href="simulate.html">tree.musse</a></span><span class="op">(</span><span class="va">pars</span>, <span class="fl">60</span>, x0<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>A<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, B<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">[</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.state</span>,<span class="op">]</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">states</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Here, states has row names corresponding to the different taxa, and</span></span></span>
<span class="r-in"><span><span class="co">## the states of two traits "A" and "B" are recorded in the columns.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">states</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      A B</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sp3  0 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sp6  0 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sp7  0 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sp9  1 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sp10 0 1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> sp11 0 1</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Note that transition from the original MuSSE basis to this basis is</span></span></span>
<span class="r-in"><span><span class="co">## only possible in general when depth=n.trait and allow.multistep=TRUE</span></span></span>
<span class="r-in"><span><span class="co">## (as only this generates a square matrix that is invertible).</span></span></span>
<span class="r-in"><span><span class="co">## However, when it is possible to express the set of parameters in the</span></span></span>
<span class="r-in"><span><span class="co">## new basis (as it is above), this can be done through a pseudoinverse</span></span></span>
<span class="r-in"><span><span class="co">## (here, a left inverse).</span></span></span>
<span class="r-in"><span><span class="va">pars2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">tr</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">tr</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">tr</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">pars</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Going from our new basis to the original MuSSE parameters is always</span></span></span>
<span class="r-in"><span><span class="co">## straightforward.  This is done automatically in the likelihood</span></span></span>
<span class="r-in"><span><span class="co">## function.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">tr</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">pars2</span><span class="op">)</span>, <span class="va">pars</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## This shows that the two traits act additively on speciation rate</span></span></span>
<span class="r-in"><span><span class="co">## (lambdaAB is zero), that there is no effect of any trait on</span></span></span>
<span class="r-in"><span><span class="co">## extinction (the only nonzero mu parameter is mu0) and transition</span></span></span>
<span class="r-in"><span><span class="co">## rates for one trait are unaffected by other traits (the only nonzero</span></span></span>
<span class="r-in"><span><span class="co">## q parameters are the qXij.0 parameters; qXij.Y parameters are all</span></span></span>
<span class="r-in"><span><span class="co">## zero).</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Here is our new MuSSE function parametrised as a multi-trait</span></span></span>
<span class="r-in"><span><span class="co">## function:</span></span></span>
<span class="r-in"><span><span class="va">lik</span> <span class="op">&lt;-</span> <span class="fu">make.musse.multitrait</span><span class="op">(</span><span class="va">phy</span>, <span class="va">states</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Here are the argument names for the likelihood function.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="argnames.html">argnames</a></span><span class="op">(</span><span class="va">lik</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [1] "lambda0"  "lambdaA"  "lambdaB"  "lambdaAB" "mu0"      "muA"     </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [7] "muB"      "muAB"     "qA01.0"   "qA01.B"   "qA10.0"   "qA10.B"  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [13] "qB01.0"   "qB01.A"   "qB10.0"   "qB10.A"  </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Basic MuSSE function for comparison</span></span></span>
<span class="r-in"><span><span class="va">lik.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="make.musse.html">make.musse</a></span><span class="op">(</span><span class="va">phy</span>, <span class="va">phy</span><span class="op">$</span><span class="va">tip.state</span>, <span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="argnames.html">argnames</a></span><span class="op">(</span><span class="va">lik.m</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [1] "lambda1" "lambda2" "lambda3" "lambda4" "mu1"     "mu2"     "mu3"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  [8] "mu4"     "q12"     "q13"     "q14"     "q21"     "q23"     "q24"    </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [15] "q31"     "q32"     "q34"     "q41"     "q42"     "q43"    </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Rather than fit this complicated model first, let's start with a</span></span></span>
<span class="r-in"><span><span class="co">## simple model with no state dependent diversification.  This model</span></span></span>
<span class="r-in"><span><span class="co">## allows the forwards and backwards transition rates to vary, but the</span></span></span>
<span class="r-in"><span><span class="co">## speciation and extinction rates do not depend on the character</span></span></span>
<span class="r-in"><span><span class="co">## state:</span></span></span>
<span class="r-in"><span><span class="va">lik0</span> <span class="op">&lt;-</span> <span class="fu">make.musse.multitrait</span><span class="op">(</span><span class="va">phy</span>, <span class="va">states</span>, depth<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="argnames.html">argnames</a></span><span class="op">(</span><span class="va">lik0</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "lambda0" "mu0"     "qA01.0"  "qA10.0"  "qB01.0"  "qB10.0" </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## This can be used in analyses as usual.  However, this can take a</span></span></span>
<span class="r-in"><span><span class="co">## while to run, so is not run by default.</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">starting.point.musse.multitrait</span><span class="op">(</span><span class="va">phy</span>, <span class="va">lik0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit0</span> <span class="op">&lt;-</span> <span class="fu"><a href="find.mle.html">find.mle</a></span><span class="op">(</span><span class="va">lik0</span>, <span class="va">p</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Now, allow the speciation rates to vary additively with both</span></span></span>
<span class="r-in"><span><span class="co">## character states (extinction and character changes are left as in the</span></span></span>
<span class="r-in"><span><span class="co">## previous model)</span></span></span>
<span class="r-in"><span><span class="va">lik1</span> <span class="op">&lt;-</span> <span class="fu">make.musse.multitrait</span><span class="op">(</span><span class="va">phy</span>, <span class="va">states</span>, depth<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Start from the previous ML point:</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">starting.point.musse.multitrait</span><span class="op">(</span><span class="va">phy</span>, <span class="va">lik1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="find.mle.html">find.mle</a></span><span class="op">(</span><span class="va">lik1</span>, <span class="va">p</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The likelihood improves, but the difference is not statistically</span></span></span>
<span class="r-in"><span><span class="co">## significant (p = 0.35).</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="va">fit1</span>, <span class="va">fit0</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## We can fit an interaction for the speciation rates, too:</span></span></span>
<span class="r-in"><span><span class="va">lik2</span> <span class="op">&lt;-</span> <span class="fu">make.musse.multitrait</span><span class="op">(</span><span class="va">phy</span>, <span class="va">states</span>, depth<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">starting.point.musse.multitrait</span><span class="op">(</span><span class="va">phy</span>, <span class="va">lik2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="find.mle.html">find.mle</a></span><span class="op">(</span><span class="va">lik2</span>, <span class="va">p</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## There is next to no support for the interaction term (which is good,</span></span></span>
<span class="r-in"><span><span class="co">## as the original model did not have any interaction!)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="va">fit2</span>, <span class="va">fit1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Constraining also works with these models.  For example, constraining</span></span></span>
<span class="r-in"><span><span class="co">## the lambdaA parameter to zero:</span></span></span>
<span class="r-in"><span><span class="va">lik1b</span> <span class="op">&lt;-</span> <span class="fu"><a href="constrain.html">constrain</a></span><span class="op">(</span><span class="va">lik1</span>, <span class="va">lambdaA</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="argnames.html">argnames</a></span><span class="op">(</span><span class="va">lik1b</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">starting.point.musse.multitrait</span><span class="op">(</span><span class="va">phy</span>, <span class="va">lik1b</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit1b</span> <span class="op">&lt;-</span> <span class="fu"><a href="find.mle.html">find.mle</a></span><span class="op">(</span><span class="va">lik1b</span>, <span class="va">p</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="va">fit1b</span>, <span class="va">fit0</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Or constraining both main effects to take the same value:</span></span></span>
<span class="r-in"><span><span class="va">lik1c</span> <span class="op">&lt;-</span> <span class="fu"><a href="constrain.html">constrain</a></span><span class="op">(</span><span class="va">lik1</span>, <span class="va">lambdaB</span> <span class="op">~</span> <span class="va">lambdaA</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="argnames.html">argnames</a></span><span class="op">(</span><span class="va">lik1c</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">starting.point.musse.multitrait</span><span class="op">(</span><span class="va">phy</span>, <span class="va">lik1c</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit1c</span> <span class="op">&lt;-</span> <span class="fu"><a href="find.mle.html">find.mle</a></span><span class="op">(</span><span class="va">lik1c</span>, <span class="va">p</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/anova.html" class="external-link">anova</a></span><span class="op">(</span><span class="va">fit1c</span>, <span class="va">fit0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Richard G. FitzJohn, Emma Goldberg, Karen Magnuson-Ford, Roger Sidje.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer></div>






  </body></html>

