<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Simple Markov Chain Monte Carlo with Slice Sampling — mcmc • diversitree</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Simple Markov Chain Monte Carlo with Slice Sampling — mcmc"><meta property="og:description" content="Run a simple-minded MCMC using slice samples (Neal 2003)
  for independent updating of each variable."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">diversitree</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.10-1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Simple Markov Chain Monte Carlo with Slice Sampling</h1>

    <div class="hidden name"><code>mcmc.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Run a simple-minded MCMC using slice samples (Neal 2003)
  for independent updating of each variable.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mcmc</span><span class="op">(</span><span class="va">lik</span>, <span class="va">x.init</span>, <span class="va">nsteps</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># Default S3 method</span></span>
<span><span class="fu">mcmc</span><span class="op">(</span><span class="va">lik</span>, <span class="va">x.init</span>, <span class="va">nsteps</span>, <span class="va">w</span>, prior<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>             sampler<span class="op">=</span><span class="va">sampler.slice</span>, fail.value<span class="op">=</span><span class="op">-</span><span class="cn">Inf</span>, lower<span class="op">=</span><span class="op">-</span><span class="cn">Inf</span>,</span>
<span>             upper<span class="op">=</span><span class="cn">Inf</span>, print.every<span class="op">=</span><span class="fl">1</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>             <span class="va">save.file</span>, save.every<span class="op">=</span><span class="fl">0</span>, save.every.dt<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>             previous<span class="op">=</span><span class="cn">NULL</span>, previous.tol<span class="op">=</span><span class="fl">1e-4</span>, keep.func<span class="op">=</span><span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">sampler.slice</span><span class="op">(</span><span class="va">lik</span>, <span class="va">x.init</span>, <span class="va">y.init</span>, <span class="va">w</span>, <span class="va">lower</span>, <span class="va">upper</span>, <span class="va">control</span><span class="op">)</span></span>
<span><span class="fu">sampler.norm</span><span class="op">(</span><span class="va">lik</span>, <span class="va">x.init</span>, <span class="va">y.init</span>, <span class="va">w</span>, <span class="va">lower</span>, <span class="va">upper</span>, <span class="va">control</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <p></p>
<dl><dt id="arg-lik">lik<a class="anchor" aria-label="anchor" href="#arg-lik"></a></dt>
<dd><p>Likelihood function to run MCMC on.  This must return the
    log likelihood (or the log of a value proportional to the
    likelihood).</p></dd>


  <dt id="arg-x-init">x.init<a class="anchor" aria-label="anchor" href="#arg-x-init"></a></dt>
<dd><p>Initial parameter location (vector).</p></dd>


  <dt id="arg-nsteps">nsteps<a class="anchor" aria-label="anchor" href="#arg-nsteps"></a></dt>
<dd><p>Number of MCMC steps to take.</p></dd>


  <dt id="arg-w">w<a class="anchor" aria-label="anchor" href="#arg-w"></a></dt>
<dd><p>Tuning parameter for the sampler.  See Details below for
    more information.</p></dd>


  <dt id="arg-prior">prior<a class="anchor" aria-label="anchor" href="#arg-prior"></a></dt>
<dd><p>An optional prior probability distribution function.
    This must be a function that returns the log prior probability,
    given a parameter vector. See <code><a href="make.prior.html">make.prior</a></code> for more
    information.  If no prior is given, unbounded (and therefore
    “improper”) priors are used for all parameters, which can
    cause the MCMC to fail in some situations.</p></dd>


  <dt id="arg-sampler">sampler<a class="anchor" aria-label="anchor" href="#arg-sampler"></a></dt>
<dd><p>Sampler to use for the MCMC.  There are currently only
    two implemented; <code>sampler.slice</code> (the default, and generally
    recommended), and <code>sampler.norm</code> (Gaussian updates, and for
    illustrative purposes mostly).</p></dd>


  <dt id="arg-lower">lower<a class="anchor" aria-label="anchor" href="#arg-lower"></a></dt>
<dd><p>Lower bounds on parameter space (scalar or vector of same
    length as <code>x.init</code>).</p></dd>


  <dt id="arg-upper">upper<a class="anchor" aria-label="anchor" href="#arg-upper"></a></dt>
<dd><p>Upper bounds on parameter space (scalar or vector of same
    length as <code>x.init</code>).</p></dd>


  <dt id="arg-fail-value">fail.value<a class="anchor" aria-label="anchor" href="#arg-fail-value"></a></dt>
<dd><p>Value to use where function evaluation fails.  The
    default (negative infinity) corresponds to zero probability.  Most
    values that fail are invalid for a given model (negative rates, etc)
    or have negligble probability, so this is reasonable.  Set to
    <code>NULL</code> to turn off checking.</p></dd>


  <dt id="arg-print-every">print.every<a class="anchor" aria-label="anchor" href="#arg-print-every"></a></dt>
<dd><p>The position and its probability will be printed
    every <code>print.every</code> generations.  Set this to 0 to disable
    printing.</p></dd>


  <dt id="arg-control">control<a class="anchor" aria-label="anchor" href="#arg-control"></a></dt>
<dd><p>List with additional control parameters for the
    sampler.  Not currently used.</p></dd>


  <dt id="arg-save-file">save.file<a class="anchor" aria-label="anchor" href="#arg-save-file"></a></dt>
<dd><p>Name of csv or rds file to save temporary output in.
    Contents will be rewritten at each save (rds is faster than csv, but
    is R-specific).</p></dd>


  <dt id="arg-save-every">save.every<a class="anchor" aria-label="anchor" href="#arg-save-every"></a></dt>
<dd><p>Number of steps to save progress into
    <code>save.file</code>.  By default this is 0, which prevents saving
    occuring.  Low nonzero values of this will slow things down, but
    may be useful during long runs.</p></dd>


  <dt id="arg-save-every-dt">save.every.dt<a class="anchor" aria-label="anchor" href="#arg-save-every-dt"></a></dt>
<dd><p>Period of time to save after, as a
    <code>lubridate</code> <code>Period</code> object (e.g., <code>minutes(10)</code>).</p></dd>


  <dt id="arg-previous">previous<a class="anchor" aria-label="anchor" href="#arg-previous"></a></dt>
<dd><p>Output from a previous <code>mcmc</code> run, perhaps only
    partly completed.  The sampler will continue from the end of this
    chain until the total chain has <code>nsteps</code> points.</p></dd>


  <dt id="arg-previous-tol">previous.tol<a class="anchor" aria-label="anchor" href="#arg-previous-tol"></a></dt>
<dd><p>Before continuing, the sampler re-evaluates the
    last point and compares the posterior probability against the
    posterior probability in the <code>previous</code> samples.  If the
    difference is greater than <code>previous.tol</code> then <code>mcmc</code> will
    not continue.</p></dd>


  <dt id="arg-keep-func">keep.func<a class="anchor" aria-label="anchor" href="#arg-keep-func"></a></dt>
<dd><p>Indicates if the returned samples should include the
    likelihood function, which can be accessed with
    <code><a href="utils.html">get.likelihood</a></code>.</p></dd>


  <dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Arguments passed to the function <code>lik</code></p></dd>


  <dt id="arg-y-init">y.init<a class="anchor" aria-label="anchor" href="#arg-y-init"></a></dt>
<dd><p>Likelihood evaluated at <code>x.init</code>.</p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>There are two samplers implemented: a slice sampler (Neal 2003) and a
basic Gaussian sampler.  In general, only the slice sampler should be
used; the Gaussian sampler is provided for illustration and as a
starting point for future samplers.</p>
<p>For slice sampling (<code>sampler.slice</code>), the tuning parameter <code>w</code>
affects how many function evaluations are required between sample
updates, but in almost all cases <strong>it does not affect how fast the
MCMC “mixes”</strong> (Neal 2003).  In particular, <code>w</code> is not analagous
to the step sizes used in conventional Metropolis-Hastings updaters that
use some fixed kernel for updates (see below).  Ideally, <code>w</code> would
be set to approximately the width of the high probability region.  I
find that chosing the distance between the 5% and 95% quantiles of the
marginal distributions of each parameter works well, computed from this
preliminary set of samples (see Examples).  If a single value is given,
this is shared across all parameters.</p>
<p>For the Gaussian updates (<code>sampler.norm</code>), the tuning parameter
<code>w</code> is the standard deviation of the normal distribution centred on
each parameter as it is updated.</p>
<p>For both samplers, if a single value is given, this is shared across all
parameters.  If a vector is given, then it must be the same length as
<code>w</code>, and parameter <code>i</code> will use <code>w[i]</code>.</p>
<p>If the MCMC is stopped by an interrupt (Escape on GUI versions of R,
Control-C on command-line version), it will return a truncated chain
with as many points as completed so far.</p>
<p>This is far from the most efficient MCMC function possible, as it was
designed to work with likelihood functions that are relatively expensive
to compute.  The overhead for 10,000 slice samples is on the order of 5s
on a 2008 Mac Pro (0.0005 s / sample).</p>
<p>The sampler function <code>sampler.norm</code> and <code>sampler.slice</code> should
not generally be called directly (though this is possible), but exist
only to be passed in to <code>mcmc</code>.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="make.bd.html">make.bd</a></code>, <code><a href="make.bisse.html">make.bisse</a></code>,
  <code><a href="make.geosse.html">make.geosse</a></code>, and <code><a href="make.mkn.html">make.mkn</a></code>, all of which
  provide likelihood functions that are suitable for use with this
  function.  The help page for <code><a href="make.bd.html">make.bd</a></code> has further
  examples of using MCMC, and <code><a href="make.bisse.html">make.bisse</a></code> has examples of
  using priors with MCMC.</p></div>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Neal R.M. 2003. Slice sampling. Annals of Statistics 31:705-767.</p>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Richard G. FitzJohn</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## Due to a change in sample() behaviour in newer R it is necessary to</span></span></span>
<span class="r-in"><span><span class="co">## use an older algorithm to replicate the previous examples</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric_version.html" class="external-link">getRversion</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="st">"3.6.0"</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">RNGkind</a></span><span class="op">(</span>sample.kind <span class="op">=</span> <span class="st">"Rounding"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-wrn co"><span class="r-pr">#&gt;</span> <span class="warning">Warning: </span>non-uniform 'Rounding' sampler used</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## To demonstrate, start with a simple bivariate normal.  The function</span></span></span>
<span class="r-in"><span><span class="co">## 'make.mvn' creates likelihood function for the multivariate normal</span></span></span>
<span class="r-in"><span><span class="co">## distribution given 'mean' (a vector) and 'vcv' (the variance</span></span></span>
<span class="r-in"><span><span class="co">## covariance matrix).  This is based on mvnorm in the package</span></span></span>
<span class="r-in"><span><span class="co">## mvtnorm, but will be faster where the vcv does not change between</span></span></span>
<span class="r-in"><span><span class="co">## calls.</span></span></span>
<span class="r-in"><span><span class="va">make.mvn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mean</span>, <span class="va">vcv</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">logdet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">determinant</a></span><span class="op">(</span><span class="va">vcv</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">modulus</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span><span class="op">)</span> <span class="op">+</span> <span class="va">logdet</span></span></span>
<span class="r-in"><span>  <span class="va">vcv.i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">vcv</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">dx</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">-</span> <span class="va">mean</span></span></span>
<span class="r-in"><span>    <span class="op">-</span><span class="op">(</span><span class="va">tmp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="op">(</span><span class="va">dx</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">vcv.i</span><span class="op">)</span> <span class="op">*</span> <span class="va">dx</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Our target distribution has mean 0, and a VCV with positive</span></span></span>
<span class="r-in"><span><span class="co">## covariance between the two parameters.</span></span></span>
<span class="r-in"><span><span class="va">vcv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.25</span>, <span class="fl">.25</span>, <span class="fl">.75</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">lik</span> <span class="op">&lt;-</span> <span class="fu">make.mvn</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">vcv</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Sample 500 points from the distribution, starting at c(0, 0).</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu">mcmc</span><span class="op">(</span><span class="va">lik</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fl">500</span>, <span class="fl">1</span>, print.every<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 100: {1.0077, 1.9016} -&gt; -4.13752</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 200: {-1.8865, -0.8726} -&gt; -3.54693</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 300: {2.7495, -0.0213} -&gt; -5.79567</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 400: {0.3627, 0.0973} -&gt; -1.71633</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 500: {-1.4309, 0.6186} -&gt; -3.36750</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The marginal distribution of V1 (the first axis of the</span></span></span>
<span class="r-in"><span><span class="co">## distribution) should be a normal distribution with mean 0 and</span></span></span>
<span class="r-in"><span><span class="co">## variance 1:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">dnorm</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">X1</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.5</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">X1</span>, <span class="fl">30</span>, add<span class="op">=</span><span class="cn">TRUE</span>, freq<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mcmc-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">X2</span> <span class="op">~</span> <span class="va">X1</span>, <span class="va">samples</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.2</span>, col<span class="op">=</span><span class="st">"#00000055"</span>, asp<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mcmc-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The estimated variance here matches nicely with the true VCV: (These</span></span></span>
<span class="r-in"><span><span class="co">## all look much better if you increase the number of sampled points,</span></span></span>
<span class="r-in"><span><span class="co">## say to 10,000)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">samples</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>           X1        X2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> X1 1.2324329 0.3168768</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> X2 0.3168768 0.8023992</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The above uses slice sampling.  We can use simple Gaussian updates</span></span></span>
<span class="r-in"><span><span class="co">## instead.  This performs updates with standard deviation '1' in each</span></span></span>
<span class="r-in"><span><span class="co">## direction.  Unlike slice sampling, the 'w' parameter here will</span></span></span>
<span class="r-in"><span><span class="co">## matter a great deal in determining how fast the chain will mix.</span></span></span>
<span class="r-in"><span><span class="va">samples.norm</span> <span class="op">&lt;-</span> <span class="fu">mcmc</span><span class="op">(</span><span class="va">lik</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, <span class="fl">500</span>, <span class="fl">1</span>, print.every<span class="op">=</span><span class="fl">100</span>,</span></span>
<span class="r-in"><span>                     sampler<span class="op">=</span><span class="va">sampler.norm</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 100: {0.2925, 0.2411} -&gt; -1.71384</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 200: {0.2392, -0.7726} -&gt; -2.18304</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 300: {1.0165, 0.9843} -&gt; -2.55494</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 400: {-0.7744, 0.7343} -&gt; -2.57660</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 500: {-0.5452, 0.4239} -&gt; -2.02740</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## This *appears* to run much faster than the slice sampling based</span></span></span>
<span class="r-in"><span><span class="co">## approach above, but the effective sample size of the second</span></span></span>
<span class="r-in"><span><span class="co">## approach is much lower.  The 'effectiveSize' function in coda says</span></span></span>
<span class="r-in"><span><span class="co">## that for 10,000 samples using slice sampling, the effective sample</span></span></span>
<span class="r-in"><span><span class="co">## size (equivalent number of independent samples) is about 8,500, but</span></span></span>
<span class="r-in"><span><span class="co">## for the Gaussian updates is only 1,200.  This can be seen by</span></span></span>
<span class="r-in"><span><span class="co">## comparing the autocorrelation between samples from the two</span></span></span>
<span class="r-in"><span><span class="co">## different runs.  </span></span></span>
<span class="r-in"><span><span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>oma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/acf.html" class="external-link">acf</a></span><span class="op">(</span><span class="va">samples</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main<span class="op">=</span><span class="st">"Slice sampling"</span>, outer<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mcmc-3.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/acf.html" class="external-link">acf</a></span><span class="op">(</span><span class="va">samples.norm</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span>main<span class="op">=</span><span class="st">"Gaussian updates"</span>, outer<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="mcmc-4.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The autocorrelation is negligable after just 2 samples under slice</span></span></span>
<span class="r-in"><span><span class="co">## sampling, but remains significant for about 15 with Gaussian</span></span></span>
<span class="r-in"><span><span class="co">## updates.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co">## Next, a diversitree likelihood example.  This example uses a 203</span></span></span>
<span class="r-in"><span><span class="co">## species phylogeny evolved under the BiSSE model.  This takes a</span></span></span>
<span class="r-in"><span><span class="co">## more substantial amount of time, so is not evaluated by default.</span></span></span>
<span class="r-in"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.03</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>, <span class="fl">0.01</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu"><a href="simulate.html">tree.bisse</a></span><span class="op">(</span><span class="va">pars</span>, max.t<span class="op">=</span><span class="fl">60</span>, x0<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## First, create a likelihood function:</span></span></span>
<span class="r-in"><span><span class="va">lik</span> <span class="op">&lt;-</span> <span class="fu"><a href="make.bisse.html">make.bisse</a></span><span class="op">(</span><span class="va">phy</span>, <span class="va">phy</span><span class="op">$</span><span class="va">tip.state</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">lik</span><span class="op">(</span><span class="va">pars</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## This produces about a sample a second, so takes a while.  The "upper"</span></span></span>
<span class="r-in"><span><span class="co">## limit is a hard upper limit, above which the sampler will never let</span></span></span>
<span class="r-in"><span><span class="co">## the parameter go (in effect, putting a uniform prior on the range</span></span></span>
<span class="r-in"><span><span class="co">## lower..upper, and returning the joint distribution conditional on the</span></span></span>
<span class="r-in"><span><span class="co">## parameters being in this range).</span></span></span>
<span class="r-in"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu">mcmc</span><span class="op">(</span><span class="va">lik</span>, <span class="va">pars</span>, nsteps<span class="op">=</span><span class="fl">100</span>, w<span class="op">=</span><span class="fl">.1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The argument 'w' works best when it is about the width of the "high</span></span></span>
<span class="r-in"><span><span class="co">## probability" region for that parameter.  This takes the with of the</span></span></span>
<span class="r-in"><span><span class="co">## 90% quantile range.  The resulting widths are only slightly faster</span></span></span>
<span class="r-in"><span><span class="co">## than the first guess.  Samples are generated about 1/s; allow 15</span></span></span>
<span class="r-in"><span><span class="co">## minutes to generate 1000 samples.</span></span></span>
<span class="r-in"><span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span>, <span class="va">quantile</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>, <span class="fl">.95</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">mcmc</span><span class="op">(</span><span class="va">lik</span>, <span class="va">pars</span>, nsteps<span class="op">=</span><span class="fl">1000</span>, w<span class="op">=</span><span class="va">w</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## You can do several things with this.  Look for candidate ML points:</span></span></span>
<span class="r-in"><span><span class="va">out</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">p</span><span class="op">)</span>,<span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Or look at the marginal distribution of parameters</span></span></span>
<span class="r-in"><span><span class="fu"><a href="profiles.plot.html">profiles.plot</a></span><span class="op">(</span><span class="va">out</span><span class="op">[</span><span class="st">"lambda0"</span><span class="op">]</span>, col.line<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Or look at the joint marginal distribution of pairs of parameters</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">lambda0</span> <span class="op">~</span> <span class="va">mu0</span>, <span class="va">out</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Richard G. FitzJohn, Emma Goldberg, Karen Magnuson-Ford, Roger Sidje.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer></div>






  </body></html>

